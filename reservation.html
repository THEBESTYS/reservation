<script>
    // URL 파라미터로부터 예약 타입 가져오기
    const urlParams = new URLSearchParams(window.location.search);
    const reservationType = urlParams.get('type') || 'learning';
    const teacherId = urlParams.get('teacher');
    const facilityId = urlParams.get('facility');
    const selectedDate = urlParams.get('date');
    
    // 예약 데이터
    let reservationData = {
        type: reservationType,
        date: '',
        time: '',
        studentName: '',
        studentGrade: '',
        parentName: '',
        parentPhone: '',
        parentEmail: '',
        specialRequest: '',
        contactTime: '',
        agreeTerms: false,
        agreeSMS: false,
        agreeEmail: false
    };
    
    // 페이지 로드 시 초기화
    document.addEventListener('DOMContentLoaded', function() {
        console.log('페이지 로드됨, 예약 타입:', reservationType);
        initReservationType();
        initDatePicker();
        initTimeSlots();
        
        if (selectedDate) {
            document.getElementById('datepicker').value = selectedDate;
            reservationData.date = selectedDate;
        }
    });
    
    // 예약 타입에 따라 UI 업데이트
    function initReservationType() {
        const typeConfigs = {
            'learning': {
                title: '학습 상담 예약',
                desc: '학생의 학습 진행 상황 및 향후 학습 계획에 대한 상담',
                icon: 'fa-comments'
            },
            'leveltest': {
                title: '레벨테스트 예약',
                desc: '학생의 영어 레벨 진단 및 반 배정 테스트',
                icon: 'fa-chart-line'
            },
            'admission': {
                title: '진학 상담 예약',
                desc: '대입/고입을 위한 전략 및 학교 선택 상담',
                icon: 'fa-university'
            }
        };
        
        const config = typeConfigs[reservationType] || typeConfigs['learning'];
        
        document.getElementById('reservation-title').textContent = config.title;
        document.getElementById('reservation-description').textContent = config.desc;
        document.getElementById('reservation-icon').className = `fas ${config.icon} reservation-icon`;
        
        // 강사 예약인 경우
        if (teacherId) {
            reservationData.type = 'makeup';
            reservationData.teacherId = teacherId;
            
            const teacherConfigs = {
                'kim': {
                    name: '김영어 강사',
                    specialty: '전문과목: 중등영어, 문법',
                    availability: '가능 시간: 월-금 16:00-20:00',
                    avatar: 'https://via.placeholder.com/80/3498db/ffffff?text=김'
                },
                'lee': {
                    name: '이회화 강사',
                    specialty: '전문과목: 회화, 스피킹',
                    availability: '가능 시간: 화-목 14:00-18:00',
                    avatar: 'https://via.placeholder.com/80/2ecc71/ffffff?text=이'
                },
                'park': {
                    name: '박작문 강사',
                    specialty: '전문과목: 작문, 에세이',
                    availability: '가능 시간: 수-금 15:00-19:00',
                    avatar: 'https://via.placeholder.com/80/e74c3c/ffffff?text=박'
                }
            };
            
            const teacher = teacherConfigs[teacherId] || teacherConfigs['kim'];
            document.getElementById('teacher-name').textContent = teacher.name;
            document.getElementById('teacher-specialty').textContent = teacher.specialty;
            document.getElementById('teacher-availability').textContent = teacher.availability;
            document.getElementById('teacher-avatar').src = teacher.avatar;
            document.getElementById('teacher-section').style.display = 'flex';
            
            document.getElementById('reservation-title').textContent = `${teacher.name} 보강 예약`;
            document.getElementById('reservation-description').textContent = teacher.specialty;
        }
        
        // 시설 예약인 경우
        if (facilityId) {
            reservationData.type = 'facility';
            reservationData.facilityId = facilityId;
            
            const facilityConfigs = {
                'studyroom_a': {
                    name: '스터디룸 A',
                    capacity: '4-6명',
                    cost: '시간당 5,000원',
                    description: '소그룹 스터디 및 모임 공간'
                },
                'studyroom_b': {
                    name: '스터디룸 B',
                    capacity: '8-12명',
                    cost: '시간당 10,000원',
                    description: '대그룹 스터디 및 세미나'
                },
                'library': {
                    name: '독서실',
                    capacity: '20석',
                    cost: '무료 (재원생)',
                    description: '조용한 자습 공간'
                }
            };
            
            const facility = facilityConfigs[facilityId] || facilityConfigs['studyroom_a'];
            document.getElementById('facility-name').textContent = facility.name;
            document.getElementById('facility-capacity').textContent = facility.capacity;
            document.getElementById('facility-cost').textContent = facility.cost;
            document.getElementById('facility-section').style.display = 'block';
            
            document.getElementById('reservation-title').textContent = `${facility.name} 예약`;
            document.getElementById('reservation-description').textContent = facility.description;
        }
    }
    
    // 날짜 선택기 초기화
    function initDatePicker() {
        flatpickr("#datepicker", {
            locale: "ko",
            dateFormat: "Y년 m월 d일 (D)",
            minDate: "today",
            maxDate: new Date().fp_incr(60), // 60일 후까지
            disable: [
                function(date) {
                    // 토요일, 일요일 비활성화 (필요시 수정)
                    return (date.getDay() === 0 || date.getDay() === 6);
                }
            ],
            onChange: function(selectedDates, dateStr) {
                console.log('날짜 선택됨:', dateStr);
                reservationData.date = dateStr;
                reservationData.time = ''; // 날짜 변경 시 시간 초기화
                updateTimeSlots();
            }
        });
    }
    
    // 시간 슬롯 초기화
    function initTimeSlots() {
        updateTimeSlots();
    }
    
    // 시간 슬롯 업데이트 - 수정된 부분!
    function updateTimeSlots() {
        const timeSlotsContainer = document.getElementById('time-slots');
        timeSlotsContainer.innerHTML = '';
        
        // 예약 타입에 따라 다른 시간대 제공
        let timeSlots = [];
        
        if (reservationData.type === 'makeup') {
            // 보강 수업 시간대
            timeSlots = ['16:00', '17:00', '18:00', '19:00'];
        } else if (reservationData.type === 'facility') {
            // 시설 예약 시간대
            timeSlots = ['09:00', '10:00', '11:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00', '20:00'];
        } else {
            // 상담 예약 시간대
            timeSlots = ['10:00', '11:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00'];
        }
        
        timeSlots.forEach(time => {
            const slot = document.createElement('div');
            slot.className = 'time-slot';
            slot.textContent = time;
            slot.dataset.time = time; // data-time 속성 추가
            
            // 랜덤으로 일부 시간대를 예약불가로 표시 (시뮬레이션)
            const isUnavailable = Math.random() > 0.7;
            
            if (isUnavailable) {
                slot.classList.add('unavailable');
                slot.title = '이미 예약된 시간입니다';
            } else {
                // 클릭 이벤트 리스너 - 수정된 부분!
                slot.addEventListener('click', function() {
                    console.log('시간 클릭됨:', this.dataset.time);
                    
                    // 모든 시간 슬롯에서 selected 클래스 제거
                    document.querySelectorAll('.time-slot').forEach(s => {
                        s.classList.remove('selected');
                    });
                    
                    // 선택된 슬롯에 selected 클래스 추가
                    this.classList.add('selected');
                    
                    // reservationData에 시간 저장 - 명시적으로 설정
                    reservationData.time = this.dataset.time;
                    
                    console.log('선택된 시간 저장됨:', reservationData.time);
                    console.log('현재 reservationData:', reservationData);
                });
            }
            
            timeSlotsContainer.appendChild(slot);
        });
        
        // 이전에 선택된 시간이 있으면 다시 선택 표시
        if (reservationData.time) {
            const selectedSlot = document.querySelector(`.time-slot[data-time="${reservationData.time}"]`);
            if (selectedSlot && !selectedSlot.classList.contains('unavailable')) {
                selectedSlot.classList.add('selected');
            }
        }
    }
    
    // 단계 이동 함수 - 수정된 부분!
    function goToStep(step) {
        console.log(`Step ${step}으로 이동 시도`);
        console.log('현재 reservationData:', reservationData);
        console.log('날짜:', reservationData.date);
        console.log('시간:', reservationData.time);
        
        // 현재 단계 유효성 검사
        if (step === 2) {
            let errorMessage = '';
            
            if (!reservationData.date) {
                errorMessage = '날짜를 선택해주세요.';
                document.getElementById('datepicker').focus();
            } else if (!reservationData.time) {
                errorMessage = '시간을 선택해주세요. 아래 예약 가능한 시간 중 하나를 클릭하세요.';
                
                // 시간 슬롯이 보이도록 스크롤
                const timeSlotsSection = document.querySelector('.time-slots-grid');
                if (timeSlotsSection) {
                    timeSlotsSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
            
            if (errorMessage) {
                alert(errorMessage);
                return;
            }
        }
        
        if (step === 3) {
            if (!validateStep2()) {
                return;
            }
        }
        
        // 모든 단계 콘텐츠 숨기기
        document.getElementById('step1').classList.remove('active');
        document.getElementById('step2').classList.remove('active');
        document.getElementById('step3').classList.remove('active');
        
        // 모든 단계 인디케이터 비활성화
        document.getElementById('step1-indicator').classList.remove('active');
        document.getElementById('step2-indicator').classList.remove('active');
        document.getElementById('step3-indicator').classList.remove('active');
        
        // 대상 단계 표시
        document.getElementById(`step${step}`).classList.add('active');
        document.getElementById(`step${step}-indicator`).classList.add('active');
        
        // 이전 단계 완료 표시
        for (let i = 1; i < step; i++) {
            document.getElementById(`step${i}-indicator`).classList.add('completed');
        }
        
        // 3단계인 경우 예약 요약 업데이트
        if (step === 3) {
            updateReservationSummary();
        }
        
        console.log(`Step ${step}으로 이동 완료`);
    }
    
    // 2단계 유효성 검사
    function validateStep2() {
        const requiredFields = [
            { id: 'student-name', name: '학생 이름' },
            { id: 'student-grade', name: '학년/반' },
            { id: 'parent-name', name: '보호자 이름' },
            { id: 'parent-phone', name: '연락처' },
            { id: 'parent-email', name: '이메일' }
        ];
        
        for (const field of requiredFields) {
            const element = document.getElementById(field.id);
            if (!element.value.trim()) {
                alert(`${field.name}을(를) 입력해주세요.`);
                element.focus();
                return false;
            }
        }
        
        // 이메일 형식 검사
        const email = document.getElementById('parent-email').value;
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            alert('유효한 이메일 주소를 입력해주세요.');
            document.getElementById('parent-email').focus();
            return false;
        }
        
        // 전화번호 형식 검사
        const phone = document.getElementById('parent-phone').value;
        const phoneRegex = /^01[0-9]-\d{3,4}-\d{4}$/;
        if (!phoneRegex.test(phone)) {
            alert('전화번호 형식은 010-1234-5678 과 같이 입력해주세요.');
            document.getElementById('parent-phone').focus();
            return false;
        }
        
        // 데이터 저장
        reservationData.studentName = document.getElementById('student-name').value;
        reservationData.studentGrade = document.getElementById('student-grade').value;
        reservationData.parentName = document.getElementById('parent-name').value;
        reservationData.parentPhone = document.getElementById('parent-phone').value;
        reservationData.parentEmail = document.getElementById('parent-email').value;
        reservationData.contactTime = document.getElementById('contact-time').value;
        reservationData.specialRequest = document.getElementById('special-request').value;
        
        return true;
    }
    
    // 예약 요약 업데이트
    function updateReservationSummary() {
        const summaryContent = document.getElementById('reservation-summary-content');
        
        // 예약 타입 이름 변환
        const typeNames = {
            'learning': '학습 상담',
            'leveltest': '레벨테스트',
            'admission': '진학 상담',
            'makeup': '보강 수업',
            'facility': '시설 예약'
        };
        
        let html = `
            <div class="reservation-detail">
                <div class="detail-row">
                    <span class="detail-label">예약 유형</span>
                    <span class="detail-value">${typeNames[reservationData.type] || '상담'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">예약 날짜</span>
                    <span class="detail-value">${reservationData.date}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">예약 시간</span>
                    <span class="detail-value">${reservationData.time}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">학생 정보</span>
                    <span class="detail-value">${reservationData.studentName} (${getGradeText(reservationData.studentGrade)})</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">보호자 정보</span>
                    <span class="detail-value">${reservationData.parentName}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">연락처</span>
                    <span class="detail-value">${reservationData.parentPhone}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">이메일</span>
                    <span class="detail-value">${reservationData.parentEmail}</span>
                </div>
        `;
        
        if (reservationData.specialRequest) {
            html += `
                <div class="detail-row">
                    <span class="detail-label">특별 요청</span>
                    <span class="detail-value">${reservationData.specialRequest}</span>
                </div>
            `;
        }
        
        html += `</div>`;
        summaryContent.innerHTML = html;
    }
    
    // 학년 텍스트 변환
    function getGradeText(gradeValue) {
        const gradeMap = {
            '초등1': '초등 1학년',
            '초등2': '초등 2학년',
            '초등3': '초등 3학년',
            '초등4': '초등 4학년',
            '초등5': '초등 5학년',
            '초등6': '초등 6학년',
            '중등1': '중등 1학년',
            '중등2': '중등 2학년',
            '중등3': '중등 3학년',
            '고등1': '고등 1학년',
            '고등2': '고등 2학년',
            '고등3': '고등 3학년'
        };
        return gradeMap[gradeValue] || gradeValue;
    }
    
    // 예약 완료
    function completeReservation() {
        // 동의 확인
        if (!document.getElementById('agree-terms').checked) {
            alert('개인정보 수집 및 이용에 동의해주세요.');
            return;
        }
        
        reservationData.agreeTerms = true;
        reservationData.agreeSMS = document.getElementById('agree-sms').checked;
        reservationData.agreeEmail = document.getElementById('agree-email').checked;
        
        // 예약 ID 생성 (실제 구현시 서버에서 생성)
        const reservationId = 'RES' + Date.now().toString().substr(-8);
        reservationData.reservationId = reservationId;
        reservationData.createdAt = new Date().toLocaleString('ko-KR');
        
        // 성공 모달 표시
        document.getElementById('success-message').innerHTML = `
            <strong>예약번호: ${reservationId}</strong><br><br>
            예약이 정상적으로 접수되었습니다.<br>
            예약 확인 메일을 발송했습니다.<br>
            예약 당일 10분 전까지 도착해주시기 바랍니다.<br><br>
            <small style="color: #666;">문의: 032-252-9600</small>
        `;
        
        document.getElementById('success-modal').style.display = 'flex';
        
        // 로컬스토리지에 저장 (임시)
        saveReservationToLocalStorage();
        
        // 콘솔에 데이터 출력 (실제 구현시 서버로 전송)
        console.log('최종 예약 데이터:', reservationData);
    }
    
    // 로컬스토리지에 예약 저장
    function saveReservationToLocalStorage() {
        const reservations = JSON.parse(localStorage.getItem('academy_reservations') || '[]');
        reservations.push(reservationData);
        localStorage.setItem('academy_reservations', JSON.stringify(reservations));
        console.log('로컬스토리지에 저장됨:', reservationData.reservationId);
    }
    
    // 예약 취소
    function cancelReservation() {
        if (confirm('예약을 취소하시겠습니까? 입력한 내용은 저장되지 않습니다.')) {
            window.location.href = 'index.html';
        }
    }
    
    // 성공 모달 후 액션
    function goToHome() {
        window.location.href = 'index.html';
    }
    
    function viewMyReservations() {
        window.location.href = 'index.html#my-reservation';
    }
    
    // ESC 키로 모달 닫기
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            document.getElementById('success-modal').style.display = 'none';
        }
    });
    
    // 모달 외부 클릭 시 닫기
    document.getElementById('success-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            this.style.display = 'none';
        }
    });
    
    // CSS에 애니메이션 추가 (style 태그에 추가할 내용)
    const style = document.createElement('style');
    style.textContent = `
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(52, 152, 219, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(52, 152, 219, 0); }
        }
        
        .time-slot.selected {
            background: #3498db;
            color: white;
            border-color: #2980b9;
            transform: scale(1.05);
            transition: all 0.3s;
        }
        
        .selection-hint {
            color: #3498db;
            font-weight: 600;
            margin-top: 10px;
            display: block;
            text-align: center;
        }
    `;
    document.head.appendChild(style);
</script>
