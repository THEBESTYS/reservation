<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë”ë² ìŠ¤íŠ¸ ì–´í•™ì› - ìƒë‹´ ì˜ˆì•½</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }
        
        .logo-icon {
            font-size: 2rem;
            margin-right: 10px;
            color: #f1c40f;
        }
        
        h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }
        
        .back-btn {
            display: inline-block;
            margin-bottom: 20px;
            padding: 10px 20px;
            background: #6c757d;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: background 0.3s;
        }
        
        .back-btn:hover {
            background: #5a6268;
        }
        
        .reservation-form {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .form-title {
            color: #2c3e50;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #3498db;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        
        .btn {
            padding: 12px 30px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            background: #2980b9;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-block {
            width: 100%;
            justify-content: center;
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        footer {
            text-align: center;
            margin-top: 50px;
            padding: 20px;
            color: #7f8c8d;
            font-size: 0.9rem;
            border-top: 1px solid #eee;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .success-message {
            display: none;
            text-align: center;
            padding: 30px;
            background: #d4edda;
            color: #155724;
            border-radius: 5px;
            margin-top: 20px;
        }
        
        .error-message {
            display: none;
            text-align: center;
            padding: 15px;
            background: #f8d7da;
            color: #721c24;
            border-radius: 5px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-calendar-check logo-icon"></i>
                <div>
                    <h1>ìƒë‹´ ì˜ˆì•½</h1>
                    <p>ë”ë² ìŠ¤íŠ¸ ì–´í•™ì› ì „ë¬¸ ìƒë‹´ ì„œë¹„ìŠ¤</p>
                </div>
            </div>
        </header>
        
        <a href="index.html" class="back-btn">
            <i class="fas fa-arrow-left"></i> ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
        </a>
        
        <div class="reservation-form">
            <h2 class="form-title">
                <i class="fas fa-edit"></i> ì˜ˆì•½ ì •ë³´ ì…ë ¥
            </h2>
            
            <form id="reservationForm">
                <!-- í•™ìƒ ì •ë³´ -->
                <div class="form-group">
                    <label for="studentName"><i class="fas fa-user-graduate"></i> í•™ìƒ ì´ë¦„ *</label>
                    <input type="text" id="studentName" name="studentName" required placeholder="í™ê¸¸ë™">
                </div>
                
                <!-- í•™ë…„/ë°˜ -->
                <div class="form-group">
                    <label for="studentGrade"><i class="fas fa-graduation-cap"></i> í•™ë…„/ë°˜ *</label>
                    <select id="studentGrade" name="studentGrade" required>
                        <option value="">ì„ íƒí•´ì£¼ì„¸ìš”</option>
                        <option value="ì´ˆ1">ì´ˆë“±í•™êµ 1í•™ë…„</option>
                        <option value="ì´ˆ2">ì´ˆë“±í•™êµ 2í•™ë…„</option>
                        <option value="ì´ˆ3">ì´ˆë“±í•™êµ 3í•™ë…„</option>
                        <option value="ì´ˆ4">ì´ˆë“±í•™êµ 4í•™ë…„</option>
                        <option value="ì´ˆ5">ì´ˆë“±í•™êµ 5í•™ë…„</option>
                        <option value="ì´ˆ6">ì´ˆë“±í•™êµ 6í•™ë…„</option>
                        <option value="ì¤‘1">ì¤‘í•™êµ 1í•™ë…„</option>
                        <option value="ì¤‘2">ì¤‘í•™êµ 2í•™ë…„</option>
                        <option value="ì¤‘3">ì¤‘í•™êµ 3í•™ë…„</option>
                        <option value="ê³ 1">ê³ ë“±í•™êµ 1í•™ë…„</option>
                        <option value="ê³ 2">ê³ ë“±í•™êµ 2í•™ë…„</option>
                        <option value="ê³ 3">ê³ ë“±í•™êµ 3í•™ë…„</option>
                    </select>
                </div>
                
                <!-- ë³´í˜¸ì ì •ë³´ -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="parentName"><i class="fas fa-user"></i> ë³´í˜¸ì ì´ë¦„ *</label>
                        <input type="text" id="parentName" name="parentName" required placeholder="í™ë¶€ëª¨">
                    </div>
                    
                    <div class="form-group">
                        <label for="parentPhone"><i class="fas fa-phone"></i> ë³´í˜¸ì ì—°ë½ì²˜ *</label>
                        <input type="tel" id="parentPhone" name="parentPhone" required placeholder="010-1234-5678">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="parentEmail"><i class="fas fa-envelope"></i> ì´ë©”ì¼ *</label>
                    <input type="email" id="parentEmail" name="parentEmail" required placeholder="parent@email.com">
                    <small style="color: #666; margin-top: 5px; display: block;">
                        ì˜ˆì•½ í™•ì¸ì„œê°€ ì´ ì´ë©”ì¼ë¡œ ë°œì†¡ë©ë‹ˆë‹¤
                    </small>
                </div>
                
                <!-- ì˜ˆì•½ ì •ë³´ -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="reservationDate"><i class="fas fa-calendar"></i> ì˜ˆì•½ ë‚ ì§œ *</label>
                        <input type="date" id="reservationDate" name="reservationDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="reservationTime"><i class="fas fa-clock"></i> ì˜ˆì•½ ì‹œê°„ *</label>
                        <select id="reservationTime" name="reservationTime" required>
                            <option value="">ì„ íƒí•´ì£¼ì„¸ìš”</option>
                            <option value="09:00">09:00</option>
                            <option value="10:00">10:00</option>
                            <option value="11:00">11:00</option>
                            <option value="14:00">14:00</option>
                            <option value="15:00">15:00</option>
                            <option value="16:00">16:00</option>
                            <option value="17:00">17:00</option>
                            <option value="18:00">18:00</option>
                            <option value="19:00">19:00</option>
                            <option value="20:00">20:00</option>
                        </select>
                    </div>
                </div>
                
                <!-- ì˜ˆì•½ ìœ í˜• -->
                <div class="form-group">
                    <label for="consultType"><i class="fas fa-comments"></i> ìƒë‹´ ìœ í˜• *</label>
                    <select id="consultType" name="consultType" required>
                        <option value="">ì„ íƒí•´ì£¼ì„¸ìš”</option>
                        <option value="learning" selected>í•™ìŠµ ìƒë‹´</option>
                        <option value="makeup">ë³´ê°• ìˆ˜ì—…</option>
                        <option value="facility">ì‹œì„¤ ì˜ˆì•½</option>
                    </select>
                </div>
                
                <!-- ì—°ë½ ê°€ëŠ¥ ì‹œê°„ -->
                <div class="form-group">
                    <label for="contactTime"><i class="fas fa-phone-volume"></i> ì—°ë½ ê°€ëŠ¥ ì‹œê°„ *</label>
                    <input type="text" id="contactTime" name="contactTime" required placeholder="ì˜ˆ: í‰ì¼ 18:00-20:00, ì£¼ë§ ì˜¤í›„">
                </div>
                
                <!-- íŠ¹ë³„ ìš”ì²­ì‚¬í•­ -->
                <div class="form-group">
                    <label for="specialRequest"><i class="fas fa-sticky-note"></i> íŠ¹ë³„ ìš”ì²­ì‚¬í•­</label>
                    <textarea id="specialRequest" name="specialRequest" rows="3" placeholder="ìƒë‹´ ì‹œ íŠ¹ë³„íˆ ë‹¤ë¤„ì£¼ì…¨ìœ¼ë©´ í•˜ëŠ” ë‚´ìš©ì´ë‚˜ ê¸°íƒ€ ìš”ì²­ì‚¬í•­ì„ ì ì–´ì£¼ì„¸ìš”."></textarea>
                </div>
                
                <!-- ì•½ê´€ ë™ì˜ -->
                <div class="form-group">
                    <label style="display: flex; align-items: flex-start; gap: 10px;">
                        <input type="checkbox" id="agreeTerms" required style="margin-top: 3px;">
                        <span>ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©ì— ë™ì˜í•©ë‹ˆë‹¤. (í•„ìˆ˜)</span>
                    </label>
                    <small style="display: block; margin-top: 5px; color: #666;">
                        ìˆ˜ì§‘ëœ ì •ë³´ëŠ” ìƒë‹´ ì˜ˆì•½ ë° ì„œë¹„ìŠ¤ ì œê³µì„ ìœ„í•œ ëª©ì ìœ¼ë¡œë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤.
                    </small>
                </div>
                
                <!-- ë¡œë”© í‘œì‹œ -->
                <div id="loading" class="loading">
                    <div class="loader"></div>
                    <p>ì˜ˆì•½ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...</p>
                </div>
                
                <!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
                <div id="errorMessage" class="error-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="errorText">ì˜ˆì•½ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</span>
                </div>
                
                <!-- ì œì¶œ ë²„íŠ¼ -->
                <div class="form-actions">
                    <button type="button" onclick="window.history.back()" class="btn" style="background: #6c757d;">
                        <i class="fas fa-times"></i> ì·¨ì†Œ
                    </button>
                    <button type="submit" class="btn btn-success btn-block">
                        <i class="fas fa-paper-plane"></i> ì˜ˆì•½ ì™„ë£Œ
                    </button>
                </div>
            </form>
        </div>
        
        <footer>
            <p>Â© 2025 ë”ë² ìŠ¤íŠ¸ ì–´í•™ì›. All rights reserved.</p>
            <p>ê³ ê°ì„¼í„°: 032-252-9600 | ì´ë©”ì¼: gcha2514@naver.com</p>
            <p>ì¸ì²œ ì—°ìˆ˜êµ¬ ì»¨ë²¤ì‹œì•„ëŒ€ë¡œ 230ë²ˆê¸¸ 42 ì•„ë¼í”„ë¼ì 2ì¸µ 207-1</p>
        </footer>
    </div>

    <script>
        // Firebase êµ¬ì„±
        const firebaseConfig = {
            apiKey: "AIzaSyD4gK47WmW78znj1jXDzwMSCH6jAN_LVN8",
            authDomain: "reservation-33a24.firebasestorage.app",
            projectId: "reservation-33a24",
            storageBucket: "reservation-33a24.firebasestorage.app",
            messagingSenderId: "965824309420",
            appId: "1:965824309420:web:060c37983c1d1c38d59709"
        };
        
        // Firebase ì´ˆê¸°í™”
        let db;
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            db = firebase.firestore();
            console.log('âœ… Firebase ì´ˆê¸°í™” ì™„ë£Œ');
        } catch (error) {
            console.error('âŒ Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', function() {
            // ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì •
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            
            // ê¸°ë³¸ ì˜ˆì•½ ë‚ ì§œë¥¼ ë‚´ì¼ë¡œ ì„¤ì •
            document.getElementById('reservationDate').value = tomorrowStr;
            document.getElementById('reservationDate').min = tomorrowStr;
            
            // URL íŒŒë¼ë¯¸í„°ì—ì„œ ì˜ˆì•½ ìœ í˜• ê°€ì ¸ì˜¤ê¸°
            const urlParams = new URLSearchParams(window.location.search);
            const type = urlParams.get('type');
            if (type) {
                document.getElementById('consultType').value = type;
            }
            
            // ë‚ ì§œ íŒŒë¼ë¯¸í„°
            const date = urlParams.get('date');
            if (date) {
                const selectedDate = new Date(date);
                if (selectedDate >= tomorrow) {
                    document.getElementById('reservationDate').value = date;
                }
            }
            
            // ì „í™”ë²ˆí˜¸ í¬ë§·íŒ…
            document.getElementById('parentPhone').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 3 && value.length <= 7) {
                    value = value.replace(/(\d{3})(\d+)/, '$1-$2');
                } else if (value.length > 7) {
                    value = value.replace(/(\d{3})(\d{4})(\d+)/, '$1-$2-$3');
                }
                e.target.value = value;
            });
        });
        
        // ì˜ˆì•½ í¼ ì œì¶œ ì²˜ë¦¬
        document.getElementById('reservationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // ë¡œë”© í‘œì‹œ
            document.getElementById('loading').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
            
            // í¼ ìœ íš¨ì„± ê²€ì‚¬
            if (!validateForm()) {
                document.getElementById('loading').style.display = 'none';
                return;
            }
            
            try {
                // ì˜ˆì•½ ë°ì´í„° ì¤€ë¹„
                const reservationData = prepareReservationData();
                console.log('ğŸ“Š ì˜ˆì•½ ë°ì´í„°:', reservationData);
                
                // Firestoreì— ì €ì¥
                if (!db) {
                    throw new Error('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                }
                
                console.log('ğŸ”¥ Firebase ì €ì¥ ì‹œì‘...');
                const docRef = await db.collection('reservations').add(reservationData);
                console.log('âœ… Firebase ì €ì¥ ì„±ê³µ! ë¬¸ì„œ ID:', docRef.id);
                
                // reply í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                redirectToReplyPage(reservationData);
                
            } catch (error) {
                console.error('âŒ ì˜ˆì•½ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('errorText').textContent = 
                    `ì˜ˆì•½ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`;
                
                if (error.code === 'permission-denied') {
                    alert('Firestore ì“°ê¸° ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. Firebase ì½˜ì†”ì—ì„œ Firestore ê·œì¹™ì„ í™•ì¸í•˜ì„¸ìš”.');
                }
            }
        });
        
        // í¼ ìœ íš¨ì„± ê²€ì‚¬
        function validateForm() {
            const requiredFields = [
                { id: 'studentName', name: 'í•™ìƒ ì´ë¦„' },
                { id: 'studentGrade', name: 'í•™ë…„/ë°˜' },
                { id: 'parentName', name: 'ë³´í˜¸ì ì´ë¦„' },
                { id: 'parentPhone', name: 'ë³´í˜¸ì ì—°ë½ì²˜' },
                { id: 'parentEmail', name: 'ì´ë©”ì¼' },
                { id: 'reservationDate', name: 'ì˜ˆì•½ ë‚ ì§œ' },
                { id: 'reservationTime', name: 'ì˜ˆì•½ ì‹œê°„' },
                { id: 'consultType', name: 'ìƒë‹´ ìœ í˜•' },
                { id: 'contactTime', name: 'ì—°ë½ ê°€ëŠ¥ ì‹œê°„' }
            ];
            
            for (const field of requiredFields) {
                const element = document.getElementById(field.id);
                if (!element.value.trim()) {
                    alert(`${field.name}ì„(ë¥¼) ì…ë ¥í•´ì£¼ì„¸ìš”.`);
                    element.focus();
                    return false;
                }
            }
            
            // ì´ë©”ì¼ í˜•ì‹ ê²€ì‚¬
            const email = document.getElementById('parentEmail').value;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('ìœ íš¨í•œ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                document.getElementById('parentEmail').focus();
                return false;
            }
            
            // ì•½ê´€ ë™ì˜ í™•ì¸
            if (!document.getElementById('agreeTerms').checked) {
                alert('ê°œì¸ì •ë³´ ì´ìš© ì•½ê´€ì— ë™ì˜í•´ì£¼ì„¸ìš”.');
                return false;
            }
            
            return true;
        }
        
        // ì˜ˆì•½ ë°ì´í„° ì¤€ë¹„
        function prepareReservationData() {
            // ì˜ˆì•½ë²ˆí˜¸ ìƒì„±
            const reservationId = generateReservationId();
            
            return {
                // í•™ìƒ ì •ë³´
                studentName: document.getElementById('studentName').value.trim(),
                studentGrade: document.getElementById('studentGrade').value,
                
                // ë³´í˜¸ì ì •ë³´
                parentName: document.getElementById('parentName').value.trim(),
                parentPhone: document.getElementById('parentPhone').value.trim(),
                parentEmail: document.getElementById('parentEmail').value.trim(),
                
                // ì˜ˆì•½ ì •ë³´
                type: document.getElementById('consultType').value,
                reservationDate: document.getElementById('reservationDate').value,
                reservationTime: document.getElementById('reservationTime').value,
                
                // ê¸°íƒ€ ì •ë³´
                contactTime: document.getElementById('contactTime').value.trim(),
                specialRequest: document.getElementById('specialRequest').value.trim(),
                
                // ì‹œìŠ¤í…œ ì •ë³´
                status: 'pending',
                reservationId: reservationId,
                source: 'reservation_site',
                createdAt: new Date(),
                updatedAt: new Date(),
                firebaseSaved: true
            };
        }
        
        // ì˜ˆì•½ë²ˆí˜¸ ìƒì„±
        function generateReservationId() {
            const now = new Date();
            const dateStr = now.getFullYear().toString().slice(2) +
                          (now.getMonth() + 1).toString().padStart(2, '0') +
                          now.getDate().toString().padStart(2, '0');
            const randomStr = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `RES${dateStr}${randomStr}`;
        }
        
        // reply í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        function redirectToReplyPage(reservationData) {
            // URL íŒŒë¼ë¯¸í„° ìƒì„±
            const params = new URLSearchParams({
                reservationId: reservationData.reservationId,
                studentName: reservationData.studentName,
                parentName: reservationData.parentName,
                parentEmail: reservationData.parentEmail,
                parentPhone: reservationData.parentPhone,
                studentGrade: reservationData.studentGrade,
                reservationDate: reservationData.reservationDate,
                reservationTime: reservationData.reservationTime,
                consultType: reservationData.type,
                contactTime: reservationData.contactTime,
                specialRequest: reservationData.specialRequest || '',
                source: 'reservation'
            });
            
            // reply ì‚¬ì´íŠ¸ URL
            // ì‹¤ì œ reply ì‚¬ì´íŠ¸ URLë¡œ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤
            const replyUrl = `https://rokyeah.github.io/reply/?${params.toString()}`;
            
            console.log('ğŸ”€ reply í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸:', replyUrl);
            
            // ë¦¬ë‹¤ì´ë ‰íŠ¸
            window.location.href = replyUrl;
        }
    </script>
</body>
</html>
